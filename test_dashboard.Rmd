---
title: "Example Resistance Dashboard"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding=encoding, output_dir = "output") })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  # cache = TRUE,
  fig.height = 5,
  echo = FALSE
)

library(crosstalk)
library(tidyverse)
library(glue)
library(plotly)
library(ggplot2)  
library(reshape2)
```

```{js}
const setDefaultValue = function(filterId, defaultValue) {
  window.addEventListener("load", function(event) { 
    document.getElementById(filterId).getElementsByClassName("selectized")[0].selectize.setValue(defaultValue, false);
  });
};
```

```{js}
const removeAllOption = function(filterId) {
  window.addEventListener("load", function(event) {
    var selectizeControl = document.getElementById(filterId).getElementsByClassName("selectized")[0].selectize;
    selectizeControl.removeOption(''); // Remove the "All" option
  });
};
```

# Overview

## Column

### Background

This is a minimal dataset (only looking at ESCO and KLPN isolated from blood cultures May this year and only a few antibiotics). It shows the basic functionality but clearly has a long was to go. We would love your feedback and what functionalities you would like to see.

# Test dataset

```{r}
pseudo_data <- readRDS("output/results/test_data.rds")
shared_data <- pseudo_data %>%
  arrange(n) %>%
  SharedData$new()
```

## Sidebar {.sidebar}

```{r}
filter_select("organism_choice", "Choose an organism", shared_data, ~Organism, multiple = FALSE)
```

```{js}
setDefaultValue("organism_choice", "ESCO");
removeAllOption("organism_choice");
```

## Column

### Antibiotic sensitivity by organism

```{r}
shared_data %>%
  plot_ly() %>%
  add_bars(
    x = ~percentage, 
    y = ~Antibiotic, 
    text = ~paste0("n=", total, ", ", round(percentage, 1), "%"), 
    textposition = "inside", 
    cliponaxis = FALSE, 
    name = ~ifelse(Sensitivity == "R", "Resistant", "Sensitive"), 
    color = ~Sensitivity, 
    colors = c("R" = "darkred", "S" = "darkgreen")
  ) %>%
  layout(
    xaxis = list(title = "Percentage", range = c(0, 100)),
    yaxis = list(title = "", categoryorder = "trace"),
    barmode = "stack",
    showlegend = TRUE,
    legend = list(title = list(text = "Sensitivity"), itemsizing = 'constant')
  )
```

# Test dataset ESBL variation no.1

```{r}
pseudo_data_ESBL <- readRDS("output/results/test_data_ESBL.rds")
shared_data_ESBL <- pseudo_data_ESBL %>%
  arrange(n) %>%
  SharedData$new()
```

## Sidebar {.sidebar}

```{r}
filter_select("organism_choice_ESBL", "Choose an organism", shared_data_ESBL, ~Organism, multiple = FALSE)
```

```{js}
setDefaultValue("organism_choice_ESBL", "ESCO");
removeAllOption("organism_choice_ESBL");
```

## Column

### Antibiotic sensitivity by organism

```{r}
shared_data_ESBL %>%
  plot_ly() %>%
  add_bars(
    x = ~percentage, 
    y = ~Antibiotic, 
    text = ~paste0("n=", total, ", ", round(percentage, 1), "%"), 
    textposition = "inside", 
    cliponaxis = FALSE, 
    name = ~case_when(Sensitivity_ESBL == "R" ~ "Resistant", 
                      Sensitivity_ESBL == "S" ~ "Sensitive", 
                      Sensitivity_ESBL == "E" ~ "ESBL"), 
    color = ~Sensitivity_ESBL, 
    colors = c("R" = "darkred", "S" = "darkgreen", "E" = "orange")
  ) %>%
  layout(
    xaxis = list(title = "Percentage", range = c(0, 100)),
    yaxis = list(title = "", categoryorder = "trace"),
    barmode = "stack",
    showlegend = TRUE,
    legend = list(title = list(text = "Sensitivity"), itemsizing = 'constant')
  )
```

### Note
This shows isolates that were *phenotypically* sensitive to amoxicillin and co-amoxiclav but had an ESBL mechanism detected on ESBL plates as orange.

# Heatmap 

### Heat Map of Antibiotic Resistance

```{r heatmap_setup}
# Calculate resistance rates
resistance_rate <- pseudo_data %>%
  group_by(Organism, Antibiotic) %>%
  summarize(ResistanceRate = mean(Sensitivity == "R")) %>%
  ungroup()

# Reshape the data into a matrix format for the heatmap
heatmap_data <- resistance_rate %>%
  pivot_wider(names_from = Antibiotic, values_from = ResistanceRate)
```
```{r heatmap_figure}
# Convert the data to a matrix format suitable for plotly
heatmap_matrix <- as.matrix(heatmap_data[,-1])  # Exclude the Organism column

# Create the heatmap
fig <- plot_ly(
  x = colnames(heatmap_matrix), 
  y = heatmap_data$Organism, 
  z = heatmap_matrix, 
  type = "heatmap",
  colors = colorRamp(c("white", "red"))
)

# Customize the layout
fig <- fig %>% layout(
  title = "Resistance Rates Heatmap",
  xaxis = list(title = "Antibiotic"),
  yaxis = list(title = "Organism")
)

# Render the plot in the RMarkdown document
fig
```

